<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Staff Login - –î–Ω–µ–≤–Ω–∏–∫ —É—Å–ø–µ—Ö–∞</title>
  <link rel="stylesheet" href="static/css/auth.css?v=3" />
  <style>
    .staff-login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }
    .staff-login-card {
      background: white;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-width: 400px;
      width: 100%;
    }
    .staff-login-title {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 24px;
    }
    .staff-form-group {
      margin-bottom: 20px;
    }
    .staff-form-group label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }
    .staff-form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    .staff-form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    .staff-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .staff-btn:hover {
      transform: translateY(-2px);
    }
    .staff-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .staff-error {
      color: #e74c3c;
      margin-top: 10px;
      text-align: center;
      display: none;
    }
    .staff-error.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="staff-login-container">
    <div class="staff-login-card">
      <h1 class="staff-login-title">üîê Staff Login</h1>
      <form id="staff-login-form">
        <div class="staff-form-group">
          <label for="staff-phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
          <input type="tel" id="staff-phone" required placeholder="+7 (999) 123-45-67" />
        </div>
        <div class="staff-form-group">
          <label for="staff-password">–ü–∞—Ä–æ–ª—å:</label>
          <input type="password" id="staff-password" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" />
        </div>
        <div id="staff-error" class="staff-error"></div>
        <button type="submit" class="staff-btn" id="staff-submit-btn">–í–æ–π—Ç–∏</button>
      </form>
    </div>
  </div>

  <script>
    // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    document.addEventListener('DOMContentLoaded', async function() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      const existingToken = sessionStorage.getItem('access_token');
      if (existingToken) {
        console.log('üîç Staff Login: –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–∫–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è—é –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å...');
        try {
          const response = await fetch('/api/staff/me', {
            headers: {
              'Authorization': `Bearer ${existingToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Staff Login: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', data.role);
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ dashboard
            window.location.replace('/staff/dashboard');
            return; // –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
          } else {
            // –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω - —É–¥–∞–ª—è–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            console.warn('‚ö†Ô∏è Staff Login: –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω, —É–¥–∞–ª—è—é');
            sessionStorage.removeItem('access_token');
          }
        } catch (error) {
          console.error('‚ùå Staff Login: –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞:', error);
          sessionStorage.removeItem('access_token');
        }
      }
      
      const form = document.getElementById('staff-login-form');
      const errorEl = document.getElementById('staff-error');
      const submitBtn = document.getElementById('staff-submit-btn');

      if (!form || !errorEl || !submitBtn) {
        console.error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã');
        return;
      }

      // –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –≤ sessionStorage
      function setAccessToken(token) {
        sessionStorage.setItem('access_token', token);
        console.log('‚úÖ –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ sessionStorage');
      }

      form.addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('üîê Staff: –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
      
      const phone = document.getElementById('staff-phone').value.trim();
      const password = document.getElementById('staff-password').value;
      
      console.log('üì§ Staff: –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:', { phone, password: '***' });
      
      if (!phone || !password) {
        errorEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        errorEl.classList.add('show');
        return;
      }
      
      errorEl.classList.remove('show');
      submitBtn.disabled = true;
      submitBtn.textContent = '–í—Ö–æ–¥...';
      
      try {
        console.log('üì§ Staff: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /api/auth/login');
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ phone, password })
        });
        
        console.log('üì• Staff: –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:', response.status, response.statusText);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ detail: '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞' }));
          throw new Error(errorData.detail || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
        }
        
        const data = await response.json();
        console.log('‚úÖ Staff: –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', { 
          has_token: !!data.access_token, 
          user_role: data.user?.role,
          user_id: data.user?.id 
        });
        
        if (!data.access_token) {
          throw new Error('–¢–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω');
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º access token
        setAccessToken(data.access_token);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ staff
        if (data.user && !['admin', 'support', 'moderator'].includes(data.user.role)) {
          throw new Error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –≠—Ç–∞ –ø–∞–Ω–µ–ª—å —Ç–æ–ª—å–∫–æ –¥–ª—è staff –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.');
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞ –ø–µ—Ä–µ–¥ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º
        const loginCard = document.querySelector('.staff-login-card');
        if (loginCard) {
          loginCard.style.display = 'none';
          console.log('‚úÖ Staff: –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ —Å–∫—Ä—ã—Ç–∞');
        }
        
        // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ staff dashboard
        console.log('üîÑ Staff: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /staff/dashboard');
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º replace –≤–º–µ—Å—Ç–æ href, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥
        window.location.replace('/staff/dashboard');
        
      } catch (error) {
        console.error('‚ùå Staff: –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
        errorEl.textContent = error.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –ø–∞—Ä–æ–ª—å.';
        errorEl.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = '–í–æ–π—Ç–∏';
      }
      });
    });
  </script>
</body>
</html>

