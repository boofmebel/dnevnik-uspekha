#!/bin/bash
# ะกะบัะธะฟั ะดะปั ัะพะทะดะฐะฝะธั ะะ ะฝะฐ ัะตัะฒะตัะต
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ะทะฐะฟัััะธัั ะฝะฐ ัะตัะฒะตัะต ะธะปะธ ัะตัะตะท SSH

set -e

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ  ะกะะะะะะะ ะะ ะะ ะกะะะะะะ                                      โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะัะพะฒะตััะตะผ, ััะพ PostgreSQL ะทะฐะฟััะตะฝ
if ! command -v psql &> /dev/null; then
    echo "โ PostgreSQL ะฝะต ัััะฐะฝะพะฒะปะตะฝ ะธะปะธ psql ะฝะต ะฝะฐะนะดะตะฝ"
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฟะพะดะบะปััะตะฝะธะต ะบ PostgreSQL
if ! psql -U postgres -c "SELECT 1" &> /dev/null; then
    echo "โ ะะต ัะดะฐะปะพัั ะฟะพะดะบะปััะธัััั ะบ PostgreSQL"
    echo "๐ก ะฃะฑะตะดะธัะตัั, ััะพ PostgreSQL ะทะฐะฟััะตะฝ ะธ ะดะพัััะฟะตะฝ"
    exit 1
fi

echo "โ PostgreSQL ะดะพัััะฟะตะฝ"
echo ""

# ะกะพะทะดะฐัะผ ัะตััะพะฒัั ะะ
echo "๐ ะกะพะทะดะฐะฝะธะต ัะตััะพะฒะพะน ะะ: dnevnik_test"
if psql -U postgres -lqt | cut -d \| -f 1 | grep -qw dnevnik_test; then
    echo "   โ๏ธ  ะะ dnevnik_test ัะถะต ัััะตััะฒัะตั"
    read -p "   ะฃะดะฐะปะธัั ะธ ะฟะตัะตัะพะทะดะฐัั? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        psql -U postgres -c "DROP DATABASE IF EXISTS dnevnik_test;"
        psql -U postgres -c "CREATE DATABASE dnevnik_test;"
        echo "   โ ะะ dnevnik_test ะฟะตัะตัะพะทะดะฐะฝะฐ"
    else
        echo "   โ ะัะฟะพะปัะทัะตะผ ัััะตััะฒััััั ะะ dnevnik_test"
    fi
else
    psql -U postgres -c "CREATE DATABASE dnevnik_test;"
    echo "   โ ะะ dnevnik_test ัะพะทะดะฐะฝะฐ"
fi

echo ""

# ะกะพะทะดะฐัะผ ะฟัะพะดะฐะบัะฝ ะะ
echo "๐ ะกะพะทะดะฐะฝะธะต ะฟัะพะดะฐะบัะฝ ะะ: dnevnik_prod"
if psql -U postgres -lqt | cut -d \| -f 1 | grep -qw dnevnik_prod; then
    echo "   โ๏ธ  ะะ dnevnik_prod ัะถะต ัััะตััะฒัะตั"
    read -p "   ะฃะดะฐะปะธัั ะธ ะฟะตัะตัะพะทะดะฐัั? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "   โ๏ธ  ะะะะะะะะ: ะญัะพ ัะดะฐะปะธั ะฒัะต ะดะฐะฝะฝัะต ะฒ ะฟัะพะดะฐะบัะฝ ะะ!"
        read -p "   ะั ัะฒะตัะตะฝั? (yes/N): " -r
        echo
        if [[ $REPLY == "yes" ]]; then
            psql -U postgres -c "DROP DATABASE IF EXISTS dnevnik_prod;"
            psql -U postgres -c "CREATE DATABASE dnevnik_prod;"
            echo "   โ ะะ dnevnik_prod ะฟะตัะตัะพะทะดะฐะฝะฐ"
        else
            echo "   โ ะััะฐะฒะปัะตะผ ัััะตััะฒััััั ะะ dnevnik_prod"
        fi
    else
        echo "   โ ะัะฟะพะปัะทัะตะผ ัััะตััะฒััััั ะะ dnevnik_prod"
    fi
else
    psql -U postgres -c "CREATE DATABASE dnevnik_prod;"
    echo "   โ ะะ dnevnik_prod ัะพะทะดะฐะฝะฐ"
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ  โ ะะะขะะะ!                                                 โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ ะกะพะทะดะฐะฝะฝัะต ะะ:"
psql -U postgres -c "\l" | grep dnevnik
echo ""
echo "๐ก ะกะปะตะดัััะธะต ัะฐะณะธ:"
echo "   1. ะะฐัััะพะนัะต .env ัะฐะนะปั ะดะปั ัะตััะพะฒะพะณะพ ะธ ะฟัะพะดะฐะบัะฝ ะพะบััะถะตะฝะธะน"
echo "   2. ะัะธะผะตะฝะธัะต ะผะธะณัะฐัะธะธ ะบ ะพะฑะตะธะผ ะะ"
echo ""



