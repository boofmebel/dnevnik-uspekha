#!/bin/bash
# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ .env Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ .ENV Ğ¤ĞĞ™Ğ›ĞĞ’ ĞĞ Ğ¡Ğ•Ğ Ğ’Ğ•Ğ Ğ•                            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

SERVER_PATH="${SERVER_PATH:-/var/www/dnevnik-uspekha}"
TEST_PATH="${SERVER_PATH}-test"

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ .env Ñ„Ğ°Ğ¹Ğ»Ğ°
create_env_file() {
    local env_path=$1
    local db_name=$2
    local env_type=$3
    
    echo "ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ .env Ğ´Ğ»Ñ $env_type Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ: $env_path"
    
    if [ -f "$env_path/backend/.env" ]; then
        echo "   âš ï¸  .env Ñ„Ğ°Ğ¹Ğ» ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
        read -p "   ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "   âœ… ĞÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ .env"
            return
        fi
    fi
    
    # Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ .env Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹
    if [ -f "$env_path/backend/.env" ]; then
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹
        cp "$env_path/backend/.env" "$env_path/backend/.env.backup"
        echo "   ğŸ’¾ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ±ÑĞºĞ°Ğ¿: .env.backup"
    fi
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ .env
    cat > "$env_path/backend/.env" << EOF
# ĞĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ: $env_type
ENVIRONMENT=$env_type

# Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
DATABASE_URL=postgresql+asyncpg://postgres:password@localhost:5432/$db_name

# Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ
SECRET_KEY=\${SECRET_KEY:-your-secret-key-here-change-in-production}

# ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€
ADMIN_PHONE=79059510009

# CORS
ALLOWED_ORIGINS=["http://localhost:8000","http://89.104.74.123:8080","http://89.104.74.123"]

# Redis (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
REDIS_URL=redis://localhost:6379/0

# Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
LOG_LEVEL=INFO
LOG_FORMAT=json
EOF
    
    echo "   âœ… .env Ñ„Ğ°Ğ¹Ğ» ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ´Ğ»Ñ $env_type"
    echo "   ğŸ“ ĞŸÑƒÑ‚ÑŒ: $env_path/backend/.env"
    echo ""
}

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ .env Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
if [ -d "$TEST_PATH" ]; then
    create_env_file "$TEST_PATH" "dnevnik_test" "development"
else
    echo "âš ï¸  Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ°Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°: $TEST_PATH"
    echo "   Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ ĞµÑ‘ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚ĞµÑÑŒ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ dev"
    echo ""
fi

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ .env Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞ½ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
if [ -d "$SERVER_PATH" ]; then
    create_env_file "$SERVER_PATH" "dnevnik_prod" "production"
else
    echo "âš ï¸  ĞŸÑ€Ğ¾Ğ´Ğ°ĞºÑˆĞ½ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°: $SERVER_PATH"
    echo "   Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ ĞµÑ‘ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚ĞµÑÑŒ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ main"
    echo ""
fi

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  âœ… Ğ“ĞĞ¢ĞĞ’Ğ!                                                 â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ’¡ Ğ’ĞĞ–ĞĞ:"
echo "   1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ SECRET_KEY Ğ² Ğ¾Ğ±Ğ¾Ğ¸Ñ… .env Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ…"
echo "   2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ PostgreSQL Ğ² DATABASE_URL"
echo "   3. ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğº Ğ¾Ğ±ĞµĞ¸Ğ¼ Ğ‘Ğ”"
echo ""



