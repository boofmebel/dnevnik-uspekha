# Backend API - –î–Ω–µ–≤–Ω–∏–∫ —É—Å–ø–µ—Ö–∞

Backend API –Ω–∞ FastAPI –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è "–î–Ω–µ–≤–Ω–∏–∫ —É—Å–ø–µ—Ö–∞".

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–æ–≥–ª–∞—Å–Ω–æ `rules.md`, –ø—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–æ–∏—Å—Ç—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:

```
routers/ ‚Üí thin controllers (—Ç–æ–ª—å–∫–æ –≤—ã–∑–æ–≤—ã —Å–µ—Ä–≤–∏—Å–æ–≤)
services/ ‚Üí –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
repositories/ ‚Üí –¥–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
schemas/ ‚Üí Pydantic –º–æ–¥–µ–ª–∏ (request/response)
models/ ‚Üí SQLAlchemy –º–æ–¥–µ–ª–∏
core/ ‚Üí –∫–æ–Ω—Ñ–∏–≥–∏, utils, exceptions, security
migrations/ ‚Üí Alembic –º–∏–≥—Ä–∞—Ü–∏–∏
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd backend
python -m venv venv
source venv/bin/activate  # –ù–∞ Windows: venv\Scripts\activate
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env –∏ —É–∫–∞–∂–∏—Ç–µ SECRET_KEY –∏ DATABASE_URL
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö PostgreSQL
createdb dnevnik_uspekha

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ SQLite –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–∏–∑–º–µ–Ω–∏—Ç–µ DATABASE_URL –≤ .env)
```

### 4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞)
alembic revision --autogenerate -m "Initial migration"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
alembic upgrade head
```

### 5. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

```bash
uvicorn main:app --reload
```

API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:8000

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API: http://localhost:8000/api/docs

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
backend/
‚îú‚îÄ‚îÄ main.py                 # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ core/                   # –Ø–¥—Ä–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ config.py          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ database.py        # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ dependencies.py    # FastAPI dependencies
‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py      # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ security/          # JWT, –ø–∞—Ä–æ–ª–∏
‚îú‚îÄ‚îÄ models/                # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îú‚îÄ‚îÄ schemas/               # Pydantic —Å—Ö–µ–º—ã
‚îú‚îÄ‚îÄ repositories/          # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (–¥–æ—Å—Ç—É–ø –∫ –ë–î)
‚îú‚îÄ‚îÄ services/             # –°–µ—Ä–≤–∏—Å—ã (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
‚îú‚îÄ‚îÄ routers/              # –†–æ—É—Ç–µ—Ä—ã (endpoints)
‚îî‚îÄ‚îÄ migrations/           # Alembic –º–∏–≥—Ä–∞—Ü–∏–∏
```

## üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JWT —Ç–æ–∫–µ–Ω—ã:

- **Access token**: —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏, —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ 15 –º–∏–Ω—É—Ç
- **Refresh token**: —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ HttpOnly cookie, —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ 30 –¥–Ω–µ–π

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

```bash
# –í—Ö–æ–¥
curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com", "password": "password"}'

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ access token
curl -X GET "http://localhost:8000/api/tasks/" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

## üìö API Endpoints

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- `POST /api/auth/login` - –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
- `POST /api/auth/refresh` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
- `POST /api/auth/logout` - –í—ã—Ö–æ–¥

### –î–µ—Ç–∏
- `GET /api/children/` - –°–ø–∏—Å–æ–∫ –¥–µ—Ç–µ–π
- `POST /api/children/` - –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–±—ë–Ω–∫–∞
- `PUT /api/children/{id}` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–±—ë–Ω–∫–∞

### –ó–∞–¥–∞—á–∏
- `GET /api/tasks/` - –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
- `POST /api/tasks/` - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
- `PUT /api/tasks/{id}` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
- `DELETE /api/tasks/{id}` - –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏

### –ó–≤—ë–∑–¥—ã
- `GET /api/stars/` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–≤—ë–∑–¥
- `POST /api/stars/add` - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–≤—ë–∑–¥
- `POST /api/stars/exchange` - –û–±–º–µ–Ω –∑–≤—ë–∑–¥ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –≤–∞–ª—é—Ç—É (–¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ –ø–æ–¥–∞—Ä–∫–∏)
- `POST /api/stars/check-streak` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–∏–∏ –¥–Ω–µ–π

### –ö–æ–ø–∏–ª–∫–∞
- `GET /api/piggy/` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ø–∏–ª–∫–∏
- `PUT /api/piggy/goal` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–ª–∏
- `POST /api/piggy/add` - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ–Ω–µ–≥

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ú–æ–¥–µ–ª–∏

- **User** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (—Ä–æ–¥–∏—Ç–µ–ª–∏ –∏ –¥–µ—Ç–∏)
- **Child** - –î–µ—Ç–∏
- **Task** - –ó–∞–¥–∞—á–∏ (—á–µ–∫-–ª–∏—Å—Ç –∏ –∫–∞–Ω–±–∞–Ω)
- **Star** - –ó–≤—ë–∑–¥—ã —Ä–µ–±—ë–Ω–∫–∞
- **StarHistory** - –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–≤—ë–∑–¥
- **StarStreak** - –°–µ—Ä–∏—è –¥–Ω–µ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á
- **Piggy** - –ö–æ–ø–∏–ª–∫–∞
- **PiggyGoal** - –¶–µ–ª—å –∫–æ–ø–∏–ª–∫–∏
- **PiggyHistory** - –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∫–æ–ø–∏–ª–∫–æ–π
- **Settings** - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–∫—É—Ä—Å –æ–±–º–µ–Ω–∞)
- **DiaryEntry** - –ó–∞–ø–∏—Å–∏ –¥–Ω–µ–≤–Ω–∏–∫–∞
- **WishlistItem** - –≠–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π
- **WeeklyStat** - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º

### –ú–∏–≥—Ä–∞—Ü–∏–∏

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ë–î –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Alembic:

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
alembic revision --autogenerate -m "–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
alembic upgrade head

# –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
alembic downgrade -1
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

–°–æ–≥–ª–∞—Å–Ω–æ `rules.md`:

- ‚úÖ JWT —Ç–æ–∫–µ–Ω—ã (access + refresh)
- ‚úÖ Refresh token –≤ HttpOnly cookie
- ‚úÖ CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `*`)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (Pydantic)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç SQL injection (SQLAlchemy ORM)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ (–∫–æ–≥–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã)
pytest
```

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–õ–æ–≥–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON (—Å–æ–≥–ª–∞—Å–Ω–æ `rules.md`):

```python
from core.config import settings

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Python logging
import logging
logger = logging.getLogger(__name__)
logger.info("–°–æ–æ–±—â–µ–Ω–∏–µ")
```

## üöÄ –î–µ–ø–ª–æ–π

–°–º. –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ `docs/DEPLOY.md`

## üìñ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `rules.md` - –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- `docs/ARCHITECTURE.md` - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `docs/SECURITY.md` - –ú–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
