name: Deploy to Production

# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ push –≤ –≤–µ—Ç–∫—É main
on:
  push:
    branches:
      - main
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ GitHub UI

jobs:
  deploy:
    name: Deploy to production server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          # –î–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ Secrets GitHub)
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 10m
          
          # –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          script: |
            set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
            echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
            if [ -z "${{ secrets.SERVER_HOST }}" ]; then
              echo "‚ùå –û–®–ò–ë–ö–ê: SERVER_HOST –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
              exit 1
            fi
            if [ -z "${{ secrets.SERVER_USER }}" ]; then
              echo "‚ùå –û–®–ò–ë–ö–ê: SERVER_USER –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
              exit 1
            fi
            if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
              echo "‚ùå –û–®–ò–ë–ö–ê: SERVER_SSH_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
              exit 1
            fi
            if [ -z "${{ secrets.SERVER_PATH }}" ]; then
              echo "‚ùå –û–®–ò–ë–ö–ê: SERVER_PATH –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
              exit 1
            fi
            echo "‚úÖ –í—Å–µ Secrets –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
            echo "SERVER_HOST: ${{ secrets.SERVER_HOST }}"
            echo "SERVER_USER: ${{ secrets.SERVER_USER }}"
            echo "SERVER_PATH: ${{ secrets.SERVER_PATH }}"
            echo "SERVER_PORT: ${{ secrets.SERVER_PORT || 22 }}"
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            echo "üìÅ –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: ${{ secrets.SERVER_PATH }}"
            if [ ! -d "${{ secrets.SERVER_PATH }}" ]; then
              echo "‚ùå –û–®–ò–ë–ö–ê: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ${{ secrets.SERVER_PATH }} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
              echo "–°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
              mkdir -p "${{ secrets.SERVER_PATH }}"
            fi
            cd ${{ secrets.SERVER_PATH }}
            echo "‚úÖ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ GitHub
            echo "üì• –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
            git fetch origin
            git reset --hard origin/main
            
            # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
            if [ -d "backend/venv" ]; then
              echo "üêç –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
              source backend/venv/bin/activate
              PIP_CMD="pip"
            else
              echo "‚ö†Ô∏è  –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–æ–∑–¥–∞—ë–º..."
              python3 -m venv backend/venv
              source backend/venv/bin/activate
              PIP_CMD="pip"
            fi
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            if [ -f "backend/requirements.txt" ]; then
              echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
              $PIP_CMD install -q -r backend/requirements.txt
            fi
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î
            if [ -f "backend/alembic.ini" ]; then
              echo "üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î (dnevnik_prod)..."
              cd backend
              # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
              if [ -f ".env" ]; then
                set -a
                source .env
                set +a
              fi
              # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î
              export DATABASE_URL=$(echo ${DATABASE_URL:-} | sed 's/dnevnik_test/dnevnik_prod/g' | sed 's/dnevnik_uspekha/dnevnik_prod/g')
              if [ -z "$DATABASE_URL" ]; then
                echo "‚ö†Ô∏è  DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏"
              else
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º Python –∏–∑ venv –¥–ª—è –∑–∞–ø—É—Å–∫–∞ alembic
                if [ -f "../venv/bin/alembic" ]; then
                  ../venv/bin/alembic upgrade head || echo "‚ö†Ô∏è  –ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (–≤–æ–∑–º–æ–∂–Ω–æ, –ë–î –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞)"
                elif [ -f "venv/bin/alembic" ]; then
                  venv/bin/alembic upgrade head || echo "‚ö†Ô∏è  –ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (–≤–æ–∑–º–æ–∂–Ω–æ, –ë–î –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞)"
                else
                  $PYTHON_CMD -m alembic upgrade head || echo "‚ö†Ô∏è  –ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (–≤–æ–∑–º–æ–∂–Ω–æ, –ë–î –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞)"
                fi
              fi
              cd ..
            fi
            
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
            echo "üåê –ü—Ä–æ–¥–∞–∫—à–Ω –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞: http://${{ secrets.SERVER_HOST }}:3000"
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
            
            # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
            # –î–ª—è systemd:
            if systemctl list-units --type=service | grep -q "dnevnik"; then
              echo "üì¶ –ù–∞–π–¥–µ–Ω systemd —Å–µ—Ä–≤–∏—Å, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º..."
              sudo systemctl reload nginx || true
              sudo systemctl restart dnevnik-uspekha || sudo systemctl restart dnevnik || true
            fi
            
            # –î–ª—è PM2:
            if command -v pm2 &> /dev/null; then
              echo "üì¶ –ù–∞–π–¥–µ–Ω PM2, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º..."
              pm2 restart dnevnik-uspekha || pm2 restart all || true
            fi
            
            # –î–ª—è uvicorn/gunicorn —á–µ—Ä–µ–∑ systemd:
            if systemctl list-units --type=service | grep -q "uvicorn\|gunicorn"; then
              echo "üì¶ –ù–∞–π–¥–µ–Ω uvicorn/gunicorn —Å–µ—Ä–≤–∏—Å, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º..."
              sudo systemctl restart uvicorn || sudo systemctl restart gunicorn || true
            fi
            
            echo "‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω!"



